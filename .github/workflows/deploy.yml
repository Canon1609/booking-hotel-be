# Tên của kịch bản tự động
name: Deploy BE to VPS

# 1. KÍCH HOẠT (ĐÃ SỬA):
# CHỈ TỰ ĐỘNG CHẠY KHI PUSH (hoặc MERGE) VÀO NHÁNH 'main'
on:
  push:
    branches:
      - main  # <-- Chỉ chạy khi có thay đổi trên 'main'

# 2. CÔNG VIỆC:
jobs:
  deploy:
    # Dùng một máy ảo Ubuntu của GitHub để chạy lệnh
    runs-on: ubuntu-latest

    # 3. CÁC BƯỚC:
    steps:
      # Dùng một "Action" có sẵn để SSH vào VPS
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          # Lấy 4 "bí mật" bạn đã cài
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          
          # 4. KỊCH BẢN (Script) ĐỂ CHẠY TRÊN VPS
          script: |
            # 1. Đi vào thư mục project
            cd ${{ secrets.VPS_PROJECT_PATH }}
            
            # 2. Kéo code mới nhất từ nhánh 'main' về
            git pull origin main
            
            # 3. Build lại image cho dịch vụ 'app' (dùng cú pháp V2)
            # (Dùng tên 'app' như trong file docker-compose.yml)
            docker compose build app
            
            # 4. Khởi động lại container 'app' (không ảnh hưởng db, redis)
            docker compose up -d --no-deps app
            
            # 5. Dọn dẹp image rác
            docker image prune -f