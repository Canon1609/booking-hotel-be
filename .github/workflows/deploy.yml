# Tên của kịch bản tự động
name: Deploy BE to VPS

# 1. KÍCH HOẠT:
# Tự động chạy khi bạn PUSH code lên nhánh 'main'
on:
  push:
    branches:
      - main # (Nếu nhánh chính của bạn tên 'master', hãy sửa lại)

# 2. CÔNG VIỆC:
jobs:
  deploy:
    # Dùng một máy ảo Ubuntu của GitHub để chạy lệnh
    runs-on: ubuntu-latest

    # 3. CÁC BƯỚC:
    steps:
      # Dùng một "Action" có sẵn để SSH vào VPS
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          # Lấy 4 "bí mật" bạn đã cài ở Giai đoạn 1
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          
          # 4. KỊCH BẢN (Script) ĐỂ CHẠY TRÊN VPS
          script: |
            # 1. Đi vào thư mục project
            cd ${{ secrets.VPS_PROJECT_PATH }}
            
            # 2. Kéo code mới nhất (mà bạn vừa push) về
            git pull origin main
            
            # 3. Build lại image cho 'backend' (nó sẽ thấy code thay đổi)
            docker-compose build backend
            
            # 4. Khởi động lại container 'backend' mà không ảnh hưởng DB, Redis
            docker-compose up -d --no-deps backend
            
            # 5. Dọn dẹp image rác (để tiết kiệm dung lượng VPS)
            docker image prune -f